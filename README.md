# 競馬AI予測システム - README

## 概要

このシステムは機械学習（LightGBM）を使用して競馬の勝敗予測を行うAIシステムです。2019年から2022年の過去データで学習し、2023年以降の新しいレースに対して予測を実行できます。StreamlitベースのWebアプリケーションとして提供され、直感的なユーザーインターフェースで予測結果を確認できます。

## システムの特徴

### 予測精度
- **ROC AUC**: 0.715
- **分類精度**: 78.15%
- **特徴量数**: 186個
- **学習データ**: 2019-2022年の競馬データ
- **予測対象**: 2023年以降の任意のレース

### 主要機能
1. **リアルタイム予測**: netkeibaから最新の出馬表を取得して予測
2. **投資判断**: 予測スコアに基づく投資推奨
3. **可視化分析**: 予測結果の詳細な分析グラフ
4. **バックテスト**: 過去データでの収益性検証

## 使用方法

### 1. Streamlitアプリの起動（推奨）
```bash
streamlit run app.py
```
ブラウザで自動的にアプリが開き、直感的なインターフェースで予測を実行できます。

### 2. 基本的な実行（コマンドライン）
```bash
python horse_racing_ai_refactored.py
```

### 2. レース選択
コード内の`selected_number`を変更することで、異なるレースを予測できます：
```python
selected_number = 1  # 1-24の範囲で選択
```

### 3. 検証用レース一覧
システムには24のテスト用レースIDが用意されています：
- **2023年**: 202301010101-202312310101（8レース）
- **2024年**: 202401010101-202412310101（8レース）
- **2025年**: 202501010101-202506010101（8レース）

## 出力ファイルの説明

### 1. 予測結果CSV
**ファイル名**: `prediction_{race_id}_{timestamp}.csv`

| 列名 | 説明 |
|------|------|
| rank | 予測順位 |
| 馬番 | 馬番号 |
| score | 予測スコア（高いほど勝率が高い） |
| 馬名 | 馬の名前 |
| 騎手 | 騎手名 |
| 馬体重 | 馬の体重（取得可能な場合） |

### 2. 予測結果JSON
**ファイル名**: `prediction_{race_id}_{timestamp}.json`

詳細な予測情報と投資判断が含まれます：
```json
{
  "race_info": {
    "race_id": "202301010101",
    "prediction_time": "2025-08-12T01:21:22",
    "total_horses": 8
  },
  "predictions": [...],
  "investment_recommendation": {
    "confidence": "high",
    "recommended_horse": 9,
    "max_score": 1.0667,
    "strategy": "積極的投資を推奨"
  }
}
```

### 3. 分析グラフ
**ファイル名**: `prediction_analysis_{race_id}_{timestamp}.png`

4つのサブプロットで構成：
- **予測スコア分布**: 全馬の予測スコアのヒストグラム
- **上位馬予測スコア**: トップ10頭の予測スコア
- **馬番vs予測スコア**: 馬番と予測スコアの散布図
- **予測信頼度**: 上位5頭の詳細スコア

## 予測スコアの解釈

### スコア範囲
- **1.0以上**: 非常に高い勝率（積極的投資推奨）
- **0.5-1.0**: 高い勝率（投資検討）
- **0.0-0.5**: 平均的な勝率
- **0.0未満**: 低い勝率（投資非推奨）

### 投資判断基準
- **最高スコア > 1.0**: 🔥 高確率予測！積極的投資を推奨
- **最高スコア 0.7-1.0**: ⚡ 中確率予測。慎重に投資検討
- **最高スコア < 0.7**: 💡 低確率予測。投資は控えめに

## 可視化の見方

### 1. 予測スコア分布 (Prediction Score Distribution)
- **X軸**: 予測スコア
- **Y軸**: 馬の頭数
- **解釈**: スコアの分布を確認し、突出した馬がいるかを判断

### 2. 上位馬予測スコア (Top 10 Horses Prediction Scores)
- **X軸**: 順位
- **Y軸**: 予測スコア
- **解釈**: 上位馬のスコア差を確認し、有力馬を特定

### 3. 馬番vs予測スコア (Horse Number vs Prediction Score)
- **X軸**: 馬番
- **Y軸**: 予測スコア
- **解釈**: 馬番による偏りがないかを確認

### 4. 予測信頼度 (Top 5 Horses Prediction Scores)
- **横棒グラフ**: 上位5頭の詳細スコア
- **解釈**: 1位と2位以下のスコア差を確認

## 特徴量の重要度

システムは186個の特徴量を使用：

### 主要特徴量カテゴリ
1. **馬の過去成績**: 過去5レース、過去9レース、全レースの成績
2. **血統情報**: 61個の血統特徴量
3. **レース条件**: 距離、馬場状態、天候
4. **馬の基本情報**: 年齢、性別、斤量、体重

### 重要度の高い特徴量（例）
- 過去成績の着順
- 過去成績の着差
- コーナー通過順位
- 血統評価値
- レース間隔

## バックテスト結果

### 収益性分析
システムは過去データでの収益性を分析し、以下の指標を提供：
- **複勝回収率**: Place Return Rate
- **単勝回収率**: Win Return Rate
- **的中率**: Hit Rate
- **投注数**: Number of Bets

### 閾値設定
予測スコアの閾値を調整することで、投資戦略を最適化できます：
- 高い閾値: 的中率向上、投注数減少
- 低い閾値: 投注数増加、的中率低下

## トラブルシューティング

### よくあるエラー

1. **レースデータが見つからない**
   ```
   ❌ レースID XXX: データが見つかりません
   ```
   - **原因**: 存在しないレースIDまたは開催前のレース
   - **対策**: 実際に開催されたレースIDを使用

2. **血統データ不足**
   ```
   ⚠️ 血統データが不足している馬があります
   ```
   - **影響**: 予測精度にわずかな影響（システムは継続動作）
   - **対策**: 特別な対応不要

3. **特徴量不足**
   ```
   ❌ 特徴量が不足しています
   ```
   - **原因**: 過去成績データが不十分
   - **対策**: デビュー戦以外の馬を含むレースを選択

## システム要件

### 必要なライブラリ
```bash
pip install streamlit pandas numpy scikit-learn lightgbm matplotlib seaborn tqdm requests beautifulsoup4
```

### データファイル
- `trained_model_optuna_model.pkl`: 学習済みモデル
- `data/horse_results.pickle`: 馬の過去成績
- `data/peds.pickle`: 血統データ
- `data/results.pickle`: レース結果
- `data/return_tables.pickle`: 払戻データ

## 更新履歴

- **v1.0** (2025-08): 初期リリース
  - LightGBM最適化モデル実装
  - リアルタイム予測機能
  - 可視化分析機能
  - 投資判断システム

## 注意事項

1. **投資判断**: このシステムの予測結果は参考情報です。実際の投資判断は自己責任で行ってください。
2. **データ依存性**: 予測精度は過去データの品質に依存します。
3. **リアルタイム性**: netkeibaからのデータ取得に時間がかかる場合があります。
4. **モデル更新**: 定期的なモデルの再学習により予測精度を維持することを推奨します。

## サポート

問題が発生した場合は、以下を確認してください：
1. レースIDの形式（YYYYMMDDRR形式）
2. 必要なデータファイルの存在
3. インターネット接続（netkeiba.comアクセス用）
4. ライブラリのバージョン互換性

---

*このREADMEは競馬AI予測システムの利用ガイドです。継続的に更新されます。*
